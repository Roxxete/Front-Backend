<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Calor - Contaminantes en El Grau de Gandía</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex; /* Activar flexbox en el cuerpo */
            flex-direction: column; /* Dirección en columna */
            font-family: Roobert, sans-serif;
        }

        .header {
            background-color: #3B6A83;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        .logo {
            width: 75px;
        }

        .nav a {
            color: #fff;
            text-decoration: none;
            margin: 0 35px;
            font-weight: normal;
        }

        #mapa {
            font-weight: bold;
        }

        .main {
            flex: 1; /* Ocupa el espacio disponible para empujar el footer hacia abajo */
            text-align: center;
            padding: 50px 20px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            position: relative;
        }

        h1::before,
        h1::after {
            content: "";
            display: inline-block;
            width: 50px;
            height: 2px;
            background-color: #3B6A83;
            margin: 0 10px;
        }

        #container {
            display: flex;
            flex: 1; /* Asegurar que el contenedor principal también expanda */
            height: auto;
        }

        #sidebar {
            width: 15%;
            background-color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #sidebar h2 {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
        }

        #sidebar ul {
            list-style: none;
            padding: 0;
        }

        #sidebar ul li {
            margin: 10px 0;
        }

        #sidebar ul li button {
            width: 100%;
            padding: 5px;
            background-color: #3B6A83;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #map {
            flex: 1;
            position: relative;
        }

        .circular-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: white;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Añadir un z-index alto */
        }

        .circular-overlay span {
            font-size: 12px;
        }

        .circular-overlay .temperature {
            font-size: 14px;
            font-weight: bold;
        }

        .circular-overlay .gas {
            font-size: 12px;
            margin-top: 5px;
        }

        .footer {
            background-color: #3B6A83;
            color: #fff;
            padding: 20px;
            text-align: center;
        }

        .footer-links a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px;
            font-size: 0.9rem;
        }

        .social-icons {
            margin-top: 15px; /* Separación extra del texto superior */
        }

        .social-icons img {
            width: 32px;
            margin: 5px;
        }

        .footer p {
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .legend {
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .legend span {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid black;
        }

        .legend .red {
            background-color: red;
        }

        .legend .yellow {
            background-color: yellow;
        }

        .legend .green {
            background-color: green;
        }
        .legend .blue {
            background-color: blue;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header class="header">
        <img src="../images/logo2.png" alt="Logo" class="logo">
        <nav class="nav">
            <a href="#" id="mapa">MAPA</a>
            <a href="#">MI PERFIL</a>
            <a href="#">CERRAR SESIÓN</a>
        </nav>
    </header>
    <div id="container">
        <div id="sidebar">
            <h2>Gases contaminantes</h2>
            <ul>
                <li><button onclick="selectGas('CO2')">CO<sub>2</sub></button></li>
                <li><button onclick="selectGas('Ozono')">Ozono</button></li>
                <li><button onclick="selectGas('SO2')">SO<sub>2</sub></button></li>
            </ul>
            <div class="legend">
                <div><span class="red"></span>Rojo: Peligro</div>
                <div><span class="yellow"></span>Amarillo: Regular</div>
                <div><span class="green"></span>Verde: Correcto</div>
                <div><span class="blue"></span>Azul: Perfecto</div>
            </div>
        </div>   
        <div id="map"> 
            <div class="circular-overlay" id="data-overlay">
                <span class="temperature">18°C</span>
                <span class="gas">1.1 ppm</span>
            </div>
        </div>
       
    </div>
    <footer class="footer">
        <div class="footer-links">
            <a href="#">Política de privacidad</a>
            <a href="#">Soporte</a>
            <a href="#">Términos y condiciones</a>
            <a href="#">Sobre nosotros</a>
        </div>
        <div class="social-icons">
            <a href="#"><img src="../images/twitter.png" alt="Twitter"></a>
            <a href="#"><img src="../images/insta.png" alt="Instagram"></a>
            <a href="#"><img src="../images/correo.png" alt="Email"></a>
        </div>
        <p>&copy; Todos los derechos reservados</p>
    </footer>

    <script>
        var map = L.map('map').setView([38.996160, -0.165172], 15);
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        var heatLayer; // Variable global para almacenar la capa de mapa de calor

        /*
        // Datos para CO2 (muchas marcas con valores exagerados)
        var heatDataCO2 = [
            [38.996160, -0.165172, 3.5], [38.996500, -0.164800, 4.2], [38.995800, -0.165500, 5.0],
            [38.997000, -0.166800, 6.0], [38.994800, -0.167200, 5.5], [38.996900, -0.164300, 4.8],
            [38.997500, -0.168000, 5.2], [38.996600, -0.166500, 5.1], [38.995200, -0.163800, 3.9],
            [38.994300, -0.165200, 4.4], [38.995700, -0.167800, 5.3], [38.993500, -0.166500, 6.0],
            [38.996800, -0.164000, 5.7], [38.994100, -0.168500, 4.6], [38.995600, -0.165000, 5.9]
        ];
    
        // Datos para Ozono
        var heatDataOzono = [
            [38.997500, -0.168000, 2.0], [38.996600, -0.163500, 2.5], [38.995800, -0.162800, 3.0],
            [38.994700, -0.166000, 2.8], [38.993900, -0.165300, 3.1], [38.995000, -0.167500, 2.9],
            [38.996400, -0.165700, 2.7], [38.995200, -0.166200, 2.4], [38.997200, -0.164000, 2.6],
            [38.993800, -0.166800, 3.0], [38.996000, -0.167800, 2.3], [38.994900, -0.168200, 2.9],
            [38.993300, -0.164300, 2.7], [38.994500, -0.165600, 2.8], [38.995900, -0.168500, 3.2]
        ];
    
        // Datos para SO2
        var heatDataSO2 = [
            [38.995500, -0.167500, 7.5], [38.997200, -0.165700, 8.0], [38.996000, -0.163000, 6.8],
            [38.994900, -0.164200, 7.2], [38.993800, -0.166800, 6.7], [38.995700, -0.163500, 8.5],
            [38.996500, -0.167000, 7.8], [38.997300, -0.166300, 8.1], [38.994000, -0.165800, 7.4],
            [38.996900, -0.164900, 8.3], [38.995400, -0.168000, 7.9], [38.993700, -0.165600, 8.0],
            [38.995800, -0.167800, 7.6], [38.996200, -0.163800, 8.4], [38.993500, -0.166500, 8.7]
        ];*/
    
        /*// Crear el heatmap inicialmente con datos de CO2
        var heatLayer = L.heatLayer(heatDataCO2, {
            radius: 50, // Mayor radio para zonas más amplias
            blur: 30,   // Mayor desenfoque
            maxZoom: 17,
            max: 8.0    // Ajustar el máximo para reflejar los datos exagerados
        }).addTo(map);
    
        // Función para cambiar los datos del heatmap
        function selectGas(gas) {
            const overlay = document.getElementById('data-overlay');
            overlay.querySelector('.gas').innerText = `Gas: ${gas}`;
    
            let newHeatData;
            if (gas === 'CO2') {
                overlay.querySelector('.temperature').innerText = '400 ppm';
                newHeatData = heatDataCO2;
            } else if (gas === 'Ozono') {
                overlay.querySelector('.temperature').innerText = '70 ppb';
                newHeatData = heatDataOzono;
            } else if (gas === 'SO2') {
                overlay.querySelector('.temperature').innerText = '10 µg/m³';
                newHeatData = heatDataSO2;
            }
    
            // Actualizar el heatmap
            map.removeLayer(heatLayer); // Eliminar la capa actual
            heatLayer = L.heatLayer(newHeatData, {
                radius: 50,
                blur: 30,
                maxZoom: 17,
                max: 8.0
            }).addTo(map); // Añadir la nueva capa
        }*/

        const estacionesCoordenadas = {
            "Pista Silla": [39.464889, -0.418656],
            "Estación X": [39.469750, -0.376510],
            "Estación Y": [39.484900, -0.347890],
            // Agrega las estaciones y sus coordenadas aquí
        };


        // Función para cargar los datos de los contaminantes y agregar los puntos al mapa
        function cargarDatosContaminante(idContaminante, gas, unidad) {
            const overlay = document.getElementById('data-overlay'); // Asegúrate de que el overlay está definido aquí
            if (!overlay) {
                console.error("El elemento con ID 'data-overlay' no existe en el HTML.");
                return;
            }
            // Realizar la solicitud AJAX para obtener los datos de las mediciones
            $.ajax({
                url: '../api/datosMapa.php', // Ruta de la API
                method: 'GET',
                data: { idcontaminante: idContaminante },
                dataType: 'json',
                success: function(response) {
                    console.log(response); // Inspecciona la respuesta en la consola
                    if (!response || response.error) {
                        console.error('Error al obtener los datos:', response.error);
                        return;
                    }

                    // Procesar los datos para el mapa de calor
                    let heatData = response.map(function(item) {
                        return [item.latitud, item.longitud, item.valor];
                    });

                    // Actualizar el mapa de calor con los nuevos datos
                    actualizarMapaCalor(heatData);

                    // Actualizar información del gas en el overlay
                    overlay.querySelector('.temperature').innerText = `${heatData.length} mediciones`;
                    overlay.querySelector('.gas').innerText = `${gas} (${unidad})`;
                    overlay.querySelector('.temperature').innerText = `Unidad: ${unidad}`;
                },
                error: function(xhr, status, error) {
                    console.log('Hubo un error en la solicitud AJAX.', status, error);
                }
            });
        }

        // Función para cargar datos desde la API externa y agregar marcadores al mapa

    function cargarDatosDesdeAPI() {
        $.ajax({
            url: 'https://valencia.opendatasoft.com/api/records/1.0/search/',
            method: 'GET',
            data: {
                dataset: 'rvvcca',
                rows: 100, // Asegúrate de incluir suficientes registros
            },
            dataType: 'json',
            success: function (response) {
                console.log(response); // Inspecciona la respuesta en la consola
                if (!response.records || response.records.length === 0) {
                    console.error('No se encontraron registros en el dataset.');
                    return;
                }

                // Encontrar la fecha más reciente entre los registros
                let fechaMasReciente = null;
                response.records.forEach(record => {
                    if (record.fields && record.fields.fecha) {
                        const fecha = new Date(record.fields.fecha);
                        if (!fechaMasReciente || fecha > new Date(fechaMasReciente)) {
                            fechaMasReciente = record.fields.fecha;
                        }
                    }
                });

                if (!fechaMasReciente) {
                    console.error('No se encontró una fecha válida en los registros.');
                    return;
                }

                console.log(`Fecha más reciente: ${fechaMasReciente}`);

                // Filtrar los registros por la fecha más reciente
                const registrosRecientes = response.records.filter(record => {
                    return record.fields && record.fields.fecha === fechaMasReciente;
                });

                console.log('Registros de la fecha más reciente:', registrosRecientes);

                // Iterar sobre los registros recientes y mostrar valores de o3, so2, y co
                registrosRecientes.forEach(record => {
                    if (record.fields && record.fields.estacion) {
                        const estacion = record.fields.estacion; // Campo que contiene el nombre de la estación
                        const coordenadas = estacionesCoordenadas[estacion]; // Busca las coordenadas en el mapeo

                        if (coordenadas) {
                            const o3 = record.fields.o3 || 'Sin dato';
                            const so2 = record.fields.so2 || 'Sin dato';
                            const co = record.fields.co || 'Sin dato';
                            const fecha = record.fields.fecha || 'Sin fecha';

                            // Agregar un marcador al mapa
                            L.marker(coordenadas)
                                .addTo(map)
                                .bindPopup(
                                    `<b>Estación:</b> ${estacion}<br>
                                     <b>O3:</b> ${o3} µg/m³<br>
                                     <b>SO2:</b> ${so2} µg/m³<br>
                                     <b>CO:</b> ${co} mg/m³<br>
                                     <b>Fecha:</b> ${fecha}`
                                );
                            console.log(`Marcador agregado para estación: ${estacion}`);
                        } else {
                            console.warn(`Coordenadas no encontradas para la estación: ${estacion}`);
                        }
                    } else {
                        console.warn('Registro sin información de estación:', record);
                    }
                });
            },
            error: function (xhr, status, error) {
                console.error('Error al obtener datos de la API externa:', status, error);
                console.error('Respuesta del servidor:', xhr.responseText);
            }
        });
    }


        // Función para cambiar los datos del heatmap
        function selectGas(gas) {
            const overlay = document.getElementById('data-overlay');
            if (!overlay) {
                console.error("El elemento con ID 'data-overlay' no existe en el HTML.");
                return;
            }

            let idContaminante;
            let unidad;

            // Determinar el ID del contaminante y su unidad
            switch (gas) {
                case 'CO2':
                    idContaminante = 1;
                    unidad = 'ppm';
                    break;
                case 'Ozono':
                    idContaminante = 2;
                    unidad = 'ppb';
                    break;
                case 'SO2':
                    idContaminante = 3;
                    unidad = 'µg/m³';
                    break;
                default:
                    console.error('Gas no reconocido:', gas);
                    return;
            }

            // Llamar a la función para cargar los datos del contaminante seleccionado
            cargarDatosContaminante(idContaminante, gas, unidad);
        }

        // Función para crear el mapa de calor
        function crearMapaCalor(heatData) {
            // Asegúrate de que `map` sea tu instancia del mapa de Leaflet
            L.heatLayer(heatData, {
                radius: 25,  // Radio de los puntos de calor (puedes ajustarlo)
                blur: 15,    // Desenfoque del mapa de calor (puedes ajustarlo)
                maxZoom: 17, // Nivel máximo de zoom
                max: 8.0
            }).addTo(map);
        }
        function actualizarMapaCalor(heatData) {
            if (heatLayer) {
                map.removeLayer(heatLayer); // Eliminar la capa actual
            }
            heatLayer = L.heatLayer(heatData, {
                radius: 50,
                blur: 30,
                maxZoom: 17,
                max: 8.0
            }).addTo(map); // Añadir la nueva capa
        }

        // Llamar a `selectGas` con "Ozono" al cargar la página
        selectGas('Ozono');

        cargarDatosDesdeAPI(); // Llamar después de inicializar el mapa
    
    </script>
    
</body>
</html>